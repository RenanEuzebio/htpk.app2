<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>HTPK Builder</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
        ></script>
    </head>
    <body class="bg-gray-900 text-gray-100 min-h-screen p-8">
        <div class="max-w-lg mx-auto" x-data="htpkBuilder()">
            <h1 class="text-2xl font-bold mb-6">HTPK Builder</h1>

            <form @submit.prevent="submitBuild" class="space-y-4">
                <!-- App ID -->
                <div>
                    <label class="block text-sm font-medium mb-1">App ID</label>
                    <input
                        type="text"
                        x-model="appId"
                        required
                        pattern="[a-z][a-z0-9_]*"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                        placeholder="myapp"
                    />
                </div>

                <!-- App Name -->
                <div>
                    <label class="block text-sm font-medium mb-1"
                        >App Name</label
                    >
                    <input
                        type="text"
                        x-model="appName"
                        required
                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                        placeholder="My App"
                    />
                </div>

                <!-- Source Type -->
                <div>
                    <label class="block text-sm font-medium mb-1">Source</label>
                    <div class="flex gap-2">
                        <button
                            type="button"
                            @click="sourceType = 'file'"
                            :class="sourceType === 'file' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'"
                            class="flex-1 py-2 rounded text-sm font-medium transition"
                        >
                            ZIP File
                        </button>
                        <button
                            type="button"
                            @click="sourceType = 'git'"
                            :class="sourceType === 'git' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'"
                            class="flex-1 py-2 rounded text-sm font-medium transition"
                        >
                            Git
                        </button>
                        <button
                            type="button"
                            @click="sourceType = 'url'"
                            :class="sourceType === 'url' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'"
                            class="flex-1 py-2 rounded text-sm font-medium transition"
                        >
                            URL
                        </button>
                    </div>
                </div>

                <!-- File Input -->
                <div x-show="sourceType === 'file'">
                    <label class="block text-sm font-medium mb-1"
                        >ZIP Archive</label
                    >
                    <input
                        type="file"
                        accept=".zip"
                        @change="zipFile = $event.target.files[0]"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm file:mr-3 file:bg-gray-700 file:border-0 file:rounded file:px-3 file:py-1 file:text-gray-100"
                    />
                    <p class="text-xs text-gray-500 mt-1">
                        Must contain index.html
                    </p>
                </div>

                <!-- Git Input -->
                <div x-show="sourceType === 'git'" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1"
                            >Repository URL</label
                        >
                        <input
                            type="url"
                            x-model="gitUrl"
                            class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                            placeholder="https://github.com/user/repo"
                        />
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium mb-1"
                                >Branch</label
                            >
                            <input
                                type="text"
                                x-model="gitBranch"
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1"
                                >Entry Point</label
                            >
                            <input
                                type="text"
                                x-model="gitEntry"
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                            />
                        </div>
                    </div>
                </div>

                <!-- URL Input -->
                <div x-show="sourceType === 'url'">
                    <label class="block text-sm font-medium mb-1"
                        >Website URL</label
                    >
                    <input
                        type="url"
                        x-model="mainUrl"
                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                        placeholder="https://example.com"
                    />
                </div>

                <!-- Icon -->
                <div>
                    <label class="block text-sm font-medium mb-1"
                        >App Icon (PNG)</label
                    >
                    <input
                        type="file"
                        accept="image/png"
                        @change="iconFile = $event.target.files[0]"
                        required
                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm file:mr-3 file:bg-gray-700 file:border-0 file:rounded file:px-3 file:py-1 file:text-gray-100"
                    />
                </div>

                <!-- Submit -->
                <button
                    type="submit"
                    :disabled="building"
                    class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed py-3 rounded font-medium transition"
                >
                    <span x-show="!building">Build APK</span>
                    <span x-show="building">Building...</span>
                </button>
            </form>

            <!-- Progress -->
            <div x-show="building" class="mt-6" x-transition>
                <div class="flex justify-between text-sm mb-2">
                    <span
                        class="text-blue-400 font-medium truncate max-w-[70%]"
                        x-text="progressMessage"
                    ></span>
                    <span
                        class="text-gray-400 font-mono"
                        x-text="progress + '%'"
                    ></span>
                </div>
                <div
                    class="w-full bg-gray-700 rounded-full h-2.5 overflow-hidden"
                >
                    <div
                        class="bg-gradient-to-r from-blue-600 to-blue-400 h-2.5 rounded-full transition-all duration-500 ease-out"
                        :style="'width: ' + progress + '%'"
                    ></div>
                </div>
                <p
                    class="text-xs text-gray-500 mt-2"
                    x-show="progress >= 50 && progress < 95"
                >
                    Gradle build in progress...
                </p>
                <p class="text-xs text-gray-500 mt-2" x-show="progress < 50">
                    Preparing build environment...
                </p>
                <p class="text-xs text-green-500 mt-2" x-show="progress >= 95">
                    Almost done!
                </p>
            </div>

            <!-- Status -->
            <div
                x-show="status"
                class="mt-4 p-3 rounded text-sm"
                :class="statusType === 'error' ? 'bg-red-900/50 border border-red-700 text-red-300' : 'bg-green-900/50 border border-green-700 text-green-300'"
            >
                <span x-text="status"></span>
            </div>
        </div>

        <script>
            const API_URL = "http://localhost:9741";

            function htpkBuilder() {
                return {
                    appId: "myapp",
                    appName: "My App",
                    sourceType: "file",
                    zipFile: null,
                    gitUrl: "",
                    gitBranch: "main",
                    gitEntry: "index.html",
                    mainUrl: "",
                    iconFile: null,
                    building: false,
                    progress: 0,
                    progressStage: "",
                    progressMessage: "",
                    status: "",
                    statusType: "",
                    eventSource: null,

                    async submitBuild() {
                        this.building = true;
                        this.status = "";
                        this.progress = 0;
                        this.progressStage = "Starting";
                        this.progressMessage = "Submitting build request...";

                        const formData = new FormData();
                        formData.append("app_id", this.appId);
                        formData.append("name", this.appName);
                        formData.append("icon", this.iconFile);

                        if (this.sourceType === "file" && this.zipFile) {
                            formData.append("zip_file", this.zipFile);
                        } else if (this.sourceType === "git") {
                            formData.append("git_url", this.gitUrl);
                            formData.append("git_branch", this.gitBranch);
                            formData.append("git_entry", this.gitEntry);
                        } else if (this.sourceType === "url") {
                            formData.append("main_url", this.mainUrl);
                        }

                        try {
                            const response = await fetch(
                                `${API_URL}/build-app`,
                                {
                                    method: "POST",
                                    body: formData,
                                },
                            );

                            if (!response.ok)
                                throw new Error(await response.text());
                            const result = await response.json();
                            this.connectProgress(result.build_id);
                        } catch (e) {
                            this.showError(e.message);
                        }
                    },

                    connectProgress(buildId) {
                        this.eventSource = new EventSource(
                            `${API_URL}/build-progress/${buildId}`,
                        );

                        this.eventSource.onmessage = (e) => {
                            const data = JSON.parse(e.data);
                            this.progress = data.progress;
                            this.progressMessage =
                                data.message || data.status || "Processing...";
                        };

                        this.eventSource.addEventListener(
                            "complete",
                            async (e) => {
                                this.eventSource.close();
                                const data = JSON.parse(e.data);
                                await this.downloadApk(data.build_id);
                            },
                        );

                        this.eventSource.addEventListener("error", (e) => {
                            this.eventSource.close();
                            if (e.data) {
                                const data = JSON.parse(e.data);
                                this.showError(data.error);
                            }
                        });
                    },

                    async downloadApk(buildId) {
                        try {
                            const response = await fetch(
                                `${API_URL}/download-apk/${buildId}`,
                            );
                            if (!response.ok)
                                throw new Error("Download failed");

                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = `${this.appId}.apk`;
                            a.click();
                            URL.revokeObjectURL(url);

                            this.status = "APK built successfully!";
                            this.statusType = "success";
                        } catch (e) {
                            this.showError(e.message);
                        }
                        this.building = false;
                    },

                    showError(msg) {
                        this.status = "Error: " + msg;
                        this.statusType = "error";
                        this.building = false;
                    },
                };
            }
        </script>
    </body>
</html>
